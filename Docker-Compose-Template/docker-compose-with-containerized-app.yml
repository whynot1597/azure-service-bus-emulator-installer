name: microsoft-azure-servicebus-emulator
services:
  emulator:
    container_name: "servicebus-emulator"
    image: mcr.microsoft.com/azure-messaging/servicebus-emulator:latest
    pull_policy: always
    volumes:
      - "${CONFIG_PATH:-../ServiceBus-Emulator/Config/Config.json}:/ServiceBus_Emulator/ConfigFiles/Config.json"
    ports:
      - "5672:5672"
      - "5300:${EMULATOR_HTTP_PORT:-5300}"
    environment:
      SQL_SERVER: sqledge
      MSSQL_SA_PASSWORD: "${SQL_PASSWORD}"  # Password should be same as what is set for SQL Edge  
      ACCEPT_EULA: ${ACCEPT_EULA}
      SQL_WAIT_INTERVAL: ${SQL_WAIT_INTERVAL} # Optional: Time in seconds to wait for SQL to be ready (default is 15 seconds)
      EMULATOR_HTTP_PORT: ${EMULATOR_HTTP_PORT:-5300} # Port on which emulator will expose Management & Health-check APIs
    depends_on:
      sqledge:
        condition: service_healthy
    networks:
      sb-emulator:
        aliases:
          - "sb-emulator"
  sqledge:
    container_name: "sqledge"
    image: "mcr.microsoft.com/azure-sql-edge:latest"
    networks:
      sb-emulator:
        aliases:
          - "sqledge"
    environment:
      ACCEPT_EULA: ${ACCEPT_EULA}
      MSSQL_SA_PASSWORD: "${SQL_PASSWORD}" # To be filled by user as per policy : https://learn.microsoft.com/en-us/sql/relational-databases/security/strong-passwords?view=sql-server-linux-ver16 
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "${SQL_PASSWORD}", "-Q", "SELECT 1"]
      interval: 3s
      timeout: 5s
      retries: 10
  dotnet-sample-client-app:
    container_name: "dotnet-sample-emulator-client"
    image: mcr.microsoft.com/dotnet/sdk:8.0
    working_dir: /src
    volumes:
      - ../Sample-Code-Snippets/NET/ServiceBus.Emulator.Console.Sample/ServiceBus.Emulator.Console.Sample:/src
    environment:
      EMULATOR_HOST: ${EMULATOR_HOST:-sb-emulator}
      EMULATOR_HTTP_PORT: ${EMULATOR_HTTP_PORT:-5300}
    command:
      - "bash"
      - "-c"
      - dotnet run -c Release --project ServiceBus.Emulator.Console.Sample.csproj
    depends_on:
      emulator:
        condition: service_started
    networks:
      sb-emulator:
        aliases:
          - "dotnet-sample-client-app"
  python-sample-client-app:
    container_name: "python-sample-emulator-client"
    image: python:3.11-slim
    working_dir: /src
    volumes:
      - ../Sample-Code-Snippets/Python/azure-service-bus-emulator-console-sample:/src
    environment:
      EMULATOR_HOST: ${EMULATOR_HOST:-sb-emulator}
      EMULATOR_HTTP_PORT: ${EMULATOR_HTTP_PORT:-5300}
    command:
      - "bash"
      - "-c"
      - >
        pip install --no-cache-dir azure-servicebus==7.14.3 && python sample-send-receive.py
    depends_on:
      emulator:
        condition: service_started
    networks:
      sb-emulator:
        aliases:
          - "python-sample-client-app"
  js-sample-client-app:
    container_name: "js-sample-emulator-client"
    image: node:20-bookworm
    working_dir: /src
    volumes:
      - ../Sample-Code-Snippets/JS/azure-service-bus-emulator-node-sample:/src
    environment:
      EMULATOR_HOST: ${EMULATOR_HOST:-sb-emulator}
      EMULATOR_HTTP_PORT: ${EMULATOR_HTTP_PORT:-5300}
    command:
      - "bash"
      - "-c"
      - >
        npm install --no-package-lock --production
        && node sample-send-receive.js
    depends_on:
      emulator:
        condition: service_started
    networks:
      sb-emulator:
        aliases:
          - "js-sample-client-app"
  go-sample-client-app:
    container_name: "go-sample-emulator-client"
    image: golang:1.23-bookworm
    working_dir: /src
    volumes:
      - ../Sample-Code-Snippets/Go/azure-service-bus-emulator-console-sample:/src
    environment:
      EMULATOR_HOST: ${EMULATOR_HOST:-sb-emulator}
      EMULATOR_HTTP_PORT: ${EMULATOR_HTTP_PORT:-5300}
    command:
      - "bash"
      - "-c"
      - >
        go mod download
        && go run .
    depends_on:
      emulator:
        condition: service_started
    networks:
      sb-emulator:
        aliases:
          - "go-sample-client-app"
  java-sample-client-app:
    container_name: "java-sample-emulator-client"
    image: maven:3.9.9-eclipse-temurin-21
    working_dir: /src
    volumes:
      - ../Sample-Code-Snippets/Java/azure-service-bus-emulator-console-sample:/src
    environment:
      EMULATOR_HOST: ${EMULATOR_HOST:-sb-emulator}
      EMULATOR_HTTP_PORT: ${EMULATOR_HTTP_PORT:-5300}
    command:
      - "bash"
      - "-c"
      - >
        mvn -q -B dependency:copy-dependencies package
        && java -cp "target/azure-service-bus-emulator-console-sample-1.0-SNAPSHOT.jar:target/dependency/*" com.contoso.org.Main
    depends_on:
      emulator:
        condition: service_started
    networks:
      sb-emulator:
        aliases:
          - "java-sample-client-app"
networks:
  sb-emulator:

